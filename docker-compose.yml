# SSH Honeypot Docker Compose Configuration
# 
# ⚠️ SECURITY WARNING ⚠️
# This honeypot is designed to attract and log malicious SSH activity.
# It should ONLY be deployed in isolated environments with proper monitoring.
# See README.md for detailed security considerations.

version: '3.8'

services:
  # SSH Honeypot Service
  honeypot:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: ssh-honeypot
    restart: unless-stopped
    
    # Network isolation - honeypot cannot reach other containers or host services
    networks:
      - honeypot_isolated
      - honeypot_monitoring
    
    ports:
      # SSH honeypot port (external:internal)
      # Change external port to avoid conflicts or for obfuscation
      - "${HONEYPOT_EXTERNAL_PORT:-2222}:2222"
    
    environment:
      - HONEYPOT_HOST=0.0.0.0
      - HONEYPOT_PORT=2222
      - HOST_KEY_FILE=/app/config/host_key_rsa
      - LOG_LEVEL=INFO
    
    volumes:
      # Persistent data storage
      - honeypot_data:/app/data
      # Log storage
      - honeypot_logs:/var/log/honeypot
      # Configuration (read-only for security)
      - ./config:/app/config:ro
    
    # Resource limits to prevent abuse
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 512M
        reservations:
          cpus: '0.1'
          memory: 128M
    
    # Security options
    security_opt:
      - no-new-privileges:true
    
    # Read-only root filesystem
    read_only: true
    
    # Temporary filesystem for writable areas
    tmpfs:
      - /tmp:noexec,nosuid,size=100m
    
    # Capabilities drop (remove all, then add only what's needed)
    cap_drop:
      - ALL
    cap_add:
      - NET_BIND_SERVICE  # Only if binding to ports < 1024
    
    # Logging configuration
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
        labels: "service_name"
        env: "OS_VERSION"

  # Dashboard Service
  dashboard:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: honeypot-dashboard
    restart: unless-stopped
    
    networks:
      - honeypot_monitoring
      - dashboard_external
    
    ports:
      # Dashboard web interface
      - "${DASHBOARD_EXTERNAL_PORT:-8080}:8080"
    
    environment:
      - DASHBOARD_HOST=0.0.0.0
      - DASHBOARD_PORT=8080
      - FLASK_SECRET_KEY=${FLASK_SECRET_KEY:-change-me-in-production}
      - FLASK_DEBUG=false
    
    volumes:
      # Shared data with honeypot
      - honeypot_data:/app/data:ro
      - honeypot_logs:/var/log/honeypot:ro
      - honeypot_reports:/app/reports
    
    # Override default command to run dashboard
    command: ["python", "-m", "dashboard.app"]
    
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 512M
    
    security_opt:
      - no-new-privileges:true
    
    depends_on:
      - honeypot
    
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # Report Generator (scheduled task)
  report-generator:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: honeypot-reports
    restart: "no"
    
    networks:
      - honeypot_monitoring
    
    environment:
      - PYTHONPATH=/app
    
    volumes:
      - honeypot_data:/app/data:ro
      - honeypot_reports:/app/reports
    
    command: ["python", "-m", "reports.daily_report"]
    
    deploy:
      resources:
        limits:
          cpus: '0.2'
          memory: 256M
    
    depends_on:
      - honeypot

  # Optional: Log aggregation with Fluentd
  fluentd:
    image: fluent/fluentd:v1.16-debian-1
    container_name: honeypot-fluentd
    restart: unless-stopped
    
    networks:
      - honeypot_monitoring
    
    volumes:
      - honeypot_logs:/var/log/honeypot:ro
      - ./config/fluentd:/fluentd/etc
    
    profiles:
      - monitoring  # Only start when explicitly requested

# Network Configuration
networks:
  # Isolated network - honeypot can only receive inbound connections
  # No outbound internet access from this network
  honeypot_isolated:
    driver: bridge
    internal: true  # No external access
    ipam:
      config:
        - subnet: 172.20.0.0/24
    
  # Monitoring network - for dashboard and log aggregation
  # Controlled access to honeypot data
  honeypot_monitoring:
    driver: bridge
    internal: true
    ipam:
      config:
        - subnet: 172.20.1.0/24
  
  # External network - only for dashboard access
  dashboard_external:
    driver: bridge
    ipam:
      config:
        - subnet: 172.20.2.0/24

# Persistent Volumes
volumes:
  honeypot_data:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: ${DATA_DIR:-./data}
  
  honeypot_logs:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: ${LOGS_DIR:-./logs}
  
  honeypot_reports:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: ${REPORTS_DIR:-./reports}
